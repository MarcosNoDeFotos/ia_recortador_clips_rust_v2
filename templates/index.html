<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Anotador de segmentos</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #fafafa;
        }

        .segment {
            margin-bottom: 25px;
            display: flex;
            align-items: flex-start;
            background: #fff;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        video {
            max-width: 320px;
            margin-right: 20px;
            border-radius: 6px;
        }

        .segment-info {
            flex: 1;
        }

        .tag-container {
            display: block;
            margin-top: 10px;
        }

        .segment-controls {
            margin-top: 5px;
            display: none;
        }

        .segment-controls button {
            margin: 2px;
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        input[type=text] {
            width: 250px;
            padding: 6px;
            margin-top: 5px;
        }

        button {
            padding: 8px 15px;
            margin: 10px 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }

        button:hover {
            opacity: 0.9;
        }

        .page-controls {
            margin-top: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .page-numbers span {
            cursor: pointer;
            margin: 0 4px;
        }

        .page-numbers .current {
            text-decoration: underline;
            font-weight: bold;
        }

        .tag {
            background: #eee;
            padding: 4px 8px;
            border-radius: 6px;
            margin-left: 4px;
            cursor: pointer;
            display: inline-block;
            font-size: 13px;
        }

        .tag:hover {
            background: #ddd;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.4s, bottom 0.4s;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
    </style>
</head>

<body>
    <div>
        <label>Duraci√≥n de segmento (segundos): </label>
        <input type="number" id="segmentDuration" value="5" min="1" style="width:80px">
        <button onclick="abrirVideo()">üé• Abrir v√≠deo</button>
    </div>

    <div id="segmentsContainer"></div>

    <div class="page-controls">
        <button onclick="prevPage()">‚¨ÖÔ∏è Anterior</button>
        <button onclick="nextPage()">Siguiente ‚û°Ô∏è</button>
        <div class="page-numbers" id="pageNumbers"></div>
    </div>

    <button id="saveButton" style="display:none; background:#4CAF50; color:#fff;"
        onclick="guardarAnotaciones()">üíæ Guardar anotaciones</button>

    <div id="toast" class="toast"></div>

    <script>
        let allSegments = [];
        let annotations = [];
        let tags = [];
        let currentPage = 0;
        const perPage = 5;
        let shiftPressed = false;

        document.addEventListener('keydown', e => {
            if (e.key === "Shift" && !shiftPressed) { shiftPressed = true; updateButtonLabels(); }
        });
        document.addEventListener('keyup', e => {
            if (e.key === "Shift") { shiftPressed = false; updateButtonLabels(); }
        });

        function showToast(msg, color = "#333") {
            const toast = document.getElementById("toast");
            toast.textContent = msg;
            toast.style.background = color;
            toast.className = "toast show";
            setTimeout(() => { toast.className = "toast"; }, 2000);
        }

        function secondsToHMS(sec) {
            const h = Math.floor(sec / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = Math.floor(sec % 60);
            const ms = Math.round((sec - Math.floor(sec)) * 1000);
            let timeStr = `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
            if(ms>0) timeStr += `.${ms.toString().padStart(3,"0")}`;
            return timeStr;
        }

        async function abrirVideo() {
            const dur = document.getElementById("segmentDuration").value;
            const res = await fetch("/abrir_video");
            const data = await res.json();
            if (data.error) return showToast(data.error, "#c0392b");

            annotations = data.annotations || [];
            tags = data.tags || [];
            await fetchSegments(dur);
            showToast("V√≠deo cargado correctamente", "#27ae60");
        }

        async function fetchSegments(duration) {
            const res = await fetch("/get_segments", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ segment_duration: duration })
            });
            const data = await res.json();
            if (data.error) return showToast(data.error, "#c0392b");

            // Construir allSegments: reemplazar segmentos originales con anotaciones si coinciden
            allSegments = [...data];
            annotations.forEach(a => {
                const idx = allSegments.findIndex(s => s.start === a.start && s.end === a.end);
                if (idx >= 0) {
                    allSegments[idx] = { ...a }; // reemplazar
                } else {
                    allSegments.push({ ...a }); // agregar si no exist√≠a
                }
            });

            allSegments.sort((a, b) => a.start - b.start);

            currentPage = 0;
            renderPage();
            renderPagination();
            document.getElementById("saveButton").style.display = "inline-block";
            document.getElementsByClassName("page-controls")[0].style.display = "flex";
        }

        function renderPagination() {
            const pages = Math.ceil(allSegments.length / perPage);
            const cont = document.getElementById("pageNumbers");
            cont.innerHTML = "";
            for(let i=0; i<pages; i++){
                const span = document.createElement("span");
                span.textContent = i+1;
                span.className = i===currentPage ? "current" : "";
                span.onclick = () => goToPage(i);
                cont.appendChild(span);
            }
        }

        function renderTags(container, input){
            container.innerHTML = "";
            tags.forEach(t=>{
                const tagEl = document.createElement("span");
                tagEl.className = "tag";
                tagEl.textContent = t;
                tagEl.onclick = ()=> input.value = t;
                container.appendChild(tagEl);
            });
        }

        function updateTagsAllSegments(){
            const container = document.getElementById("segmentsContainer");
            const segmentDivs = container.querySelectorAll(".segment");
            segmentDivs.forEach(segDiv => {
                const input = segDiv.querySelector("input[type=text]");
                const tagContainer = segDiv.querySelector(".tag-container");
                if(input && tagContainer) renderTags(tagContainer,input);
            });
        }

        function renderPage(){
            const container = document.getElementById("segmentsContainer");
            container.innerHTML = "";

            const startIdx = currentPage * perPage;
            const subset = allSegments.slice(startIdx, startIdx + perPage);
            const total = allSegments.length;

            subset.forEach((s, idx)=>{
                const segIndex = startIdx + idx;
                const segDiv = document.createElement("div");
                segDiv.className = "segment";

                const video = document.createElement("video");
                video.controls = true;
                video.src = `/video#t=${s.start},${s.end}`;
                video.id = `video_${segIndex}`;
                video.addEventListener("timeupdate", ()=>{ if(video.currentTime>=s.end) video.currentTime=s.start; });

                const infoDiv = document.createElement("div");
                infoDiv.className = "segment-info";

                const labelP = document.createElement("p");
                labelP.id = `time_${segIndex}`;
                labelP.textContent = `${secondsToHMS(s.start)} - ${secondsToHMS(s.end)}`;

                const input = document.createElement("input");
                input.type = "text";
                input.placeholder = "Escribe anotaci√≥n...";
                input.value = s.label || "";

                const indicator = document.createElement("span");
                indicator.style.marginLeft = "10px";
                indicator.textContent = `[${segIndex+1}/${total}]`;

                const editBtn = document.createElement("button");
                editBtn.textContent = "‚úèÔ∏è Editar segmento";
                editBtn.style.marginLeft = "10px";
                editBtn.onclick = () => toggleSegmentControls(segIndex);

                const tagContainer = document.createElement("span");
                tagContainer.className = "tag-container";
                renderTags(tagContainer,input);

                const controlsDiv = document.createElement("div");
                controlsDiv.className = "segment-controls";
                controlsDiv.id = `controls_${segIndex}`;

                const btnData = [
                    ["‚¨ÖÔ∏è Inicio -1s","start",-1],
                    ["Inicio +1s ‚û°Ô∏è","start",1],
                    ["‚¨ÖÔ∏è Fin -1s","end",-1],
                    ["Fin +1s ‚û°Ô∏è","end",1]
                ];
                btnData.forEach(([txt,part,delta])=>{
                    const b = document.createElement("button");
                    b.dataset.baseText = txt;
                    b.textContent = txt;
                    b.onmousedown = ()=> adjustSegment(segIndex, part, delta);
                    controlsDiv.appendChild(b);
                });

                infoDiv.append(labelP,input,indicator,editBtn,controlsDiv,tagContainer);
                segDiv.append(video, infoDiv);
                container.appendChild(segDiv);
            });
        }

        function toggleSegmentControls(index){
            const div = document.getElementById(`controls_${index}`);
            div.style.display = div.style.display==="block"?"none":"block";
        }

       function adjustSegment(index, part, delta){
            const s = allSegments[index];
            if(!s) return;
            const step = shiftPressed ? 0.1 : 1;

            if(part === "start"){ 
                s.start = Math.max(0, s.start + delta*step);
                if(s.start >= s.end) s.start = s.end - 0.1;
            } else { // "end"
                s.end = Math.max(s.start + 0.1, s.end + delta*step);
            }

            // Actualizar solo el DOM del segmento afectado
            const labelP = document.getElementById(`time_${index}`);
            if(labelP) labelP.textContent = `${secondsToHMS(s.start)} - ${secondsToHMS(s.end)}`;

            const video = document.getElementById(`video_${index}`);
            if(video) video.currentTime = s.start;
        };
        function goToPage(i){ guardarAnotaciones(false); currentPage=i; renderPage(); renderPagination(); }
        function nextPage(){ if((currentPage+1)*perPage<allSegments.length){ guardarAnotaciones(false); currentPage++; renderPage(); renderPagination(); } }
        function prevPage(){ if(currentPage>0){ guardarAnotaciones(false); currentPage--; renderPage(); renderPagination(); } }

        async function guardarAnotaciones(showToastMsg=true){
            const startIdx = currentPage*perPage;
            const subset = allSegments.slice(startIdx,startIdx+perPage);
            subset.forEach((s,i)=>{
                const input = document.querySelectorAll(".segment input")[i];
                const label = input?.value?.trim();
                if(label && label.length>0) s.label=label;
            });

            annotations = allSegments.filter(s=>s.label);
            const res = await fetch("/save_annotations", {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({annotations})
            });
            const result = await res.json();
            tags = result.tags || tags;
            updateTagsAllSegments();
            if(showToastMsg) showToast("Anotaciones guardadas correctamente","#27ae60");
        }

        function updateButtonLabels(){
            const controls = document.querySelectorAll('.segment-controls');
            controls.forEach(div=>{
                const buttons = div.querySelectorAll('button');
                buttons.forEach(b=>{
                    let text = b.dataset.baseText;
                    if(shiftPressed){
                        if(text.includes('+1s')) text=text.replace('+1s','+0.1s');
                        if(text.includes('-1s')) text=text.replace('-1s','-0.1s');
                    }
                    b.textContent=text;
                });
            });
        }
    </script>
</body>
</html>
